<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Upload Faces</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Upload Attendee Faces</h1>
  <input type="text" id="name" placeholder="Attendee Name">
  <input type="file" id="image" accept="image/*">
  <button onclick="uploadFace()">Upload</button>
  <p id="uploadStatus" style="font-family: monospace; white-space: pre-wrap;"></p>
  <button onclick="window.location.href='index.html'">Go to Scanner</button>

  <script>
    // Initialize Supabase with error handling
    let supabase;
    try {
      const SUPABASE_URL = 'https://dorqltesgjhtyoojbnnp.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvcnFsdGVzZ2podHlvb2pibm5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MDM3NDQsImV4cCI6MjA3MTQ3OTc0NH0.zP5q_E0wxKu_E4XA6RwtHLJaTfNUbxSxGfb3vtfFpMI';
      
      // Check if supabase object is available
      if (typeof supabase !== 'undefined') {
        supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase client initialized successfully');
      } else {
        throw new Error('Supabase library not loaded');
      }
    } catch (error) {
      console.error('Supabase initialization failed:', error);
      document.getElementById('uploadStatus').innerText = 'Error: Supabase client failed to initialize. Please refresh the page.';
    }

    async function uploadFace() {
      const name = document.getElementById('name').value;
      const fileInput = document.getElementById('image');
      const file = fileInput.files[0];
      const statusElement = document.getElementById('uploadStatus');

      if (!name || !file) {
        statusElement.innerText = '‚ùå Please enter a name and select an image file.';
        return;
      }

      // Check if supabase client is initialized
      if (!supabase) {
        statusElement.innerText = '‚ùå Supabase client not initialized. Please refresh the page.';
        return;
      }

      statusElement.innerText = 'üîÑ Starting upload process...';
      
      try {
        console.log('=== UPLOAD PROCESS STARTED ===');
        console.log('File:', file.name, 'Size:', file.size, 'Type:', file.type);

        // 1. UPLOAD TO STORAGE
        statusElement.innerText += '\nüîÑ Uploading to storage...';
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('faces')
          .upload(file.name, file, { upsert: true });

        if (uploadError) {
          console.error('STORAGE UPLOAD ERROR:', uploadError);
          throw new Error(`STORAGE UPLOAD FAILED:\n${uploadError.message}\nStatus: ${uploadError.statusCode}`);
        }

        console.log('‚úÖ Storage upload successful:', uploadData);
        statusElement.innerText += '\n‚úÖ File uploaded to storage!';

        // 2. GET PUBLIC URL
        statusElement.innerText += '\nüîÑ Generating public URL...';
        const { data: urlData } = supabase.storage
          .from('faces')
          .getPublicUrl(uploadData.path);

        const publicUrl = urlData.publicUrl;
        console.log('üåê Public URL:', publicUrl);
        statusElement.innerText += `\nüåê Public URL: ${publicUrl}`;

        // 3. INSERT INTO DATABASE
        statusElement.innerText += '\nüîÑ Saving to database...';
        const { data: dbData, error: dbError } = await supabase
          .from('attendees')
          .insert([{ 
            name: name, 
            image_url: publicUrl 
          }]);

        if (dbError) {
          console.error('DATABASE ERROR:', dbError);
          throw new Error(`DATABASE INSERT FAILED:\n${dbError.message}\nDetails: ${dbError.details}`);
        }

        console.log('‚úÖ Database insert successful:', dbData);
        
        // SUCCESS
        statusElement.innerHTML = `‚úÖ <strong>SUCCESS!</strong>\n\nName: ${name}\nFile: ${file.name}\nURL: ${publicUrl}\n\nFace uploaded successfully!`;
        statusElement.style.color = 'green';
        
        // Clear form
        document.getElementById('name').value = '';
        fileInput.value = '';

      } catch (error) {
        console.error('FULL ERROR:', error);
        statusElement.innerHTML = `‚ùå <strong>ERROR:</strong>\n\n${error.message}`;
        statusElement.style.color = 'red';
      }
    }
  </script>
</body>
</html>
